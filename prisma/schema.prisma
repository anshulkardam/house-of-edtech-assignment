// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  STUDENT
  ADMIN
  SUPER_ADMIN
}

model User {
  id       String   @id @default(cuid())
  name     String
  email    String   @unique
  password String
  image    String?
  role     UserRole @default(STUDENT)
  admin    Admin?
  student  Student?

  aiModel       AIModel        @default(gpt_4o)
  creditBalance CreditBalance?
  transactions  Transaction[]
  sessions      Session[]
  adminRequests AdminRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Admin {
  userId String @id

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  courses   Course[]
}

model AdminRequest {
  id     String             @id @default(cuid())
  userId String
  user   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  status AdminRequestStatus @default(PENDING)
  reason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([status])
}

enum AdminRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model Student {
  userId String @id

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  //TODO: add subscription model

  conversations  Conversation[]
  tests          Test[]
  courseProgress CourseProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CourseProgress {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  enrolledAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

//TODO: move to Redis 
model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model Course {
  id String @id @default(cuid())

  slug        String  @unique
  title       String
  description String  @db.Text
  image       String?
  published   Boolean @default(false)

  chapters Chapter[]
  tests    Test[]
  progress CourseProgress[]
  //TODO: add completion cert or trophy

  createdByAdminId String
  admin            Admin  @relation(fields: [createdByAdminId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([published])
  @@index([createdByAdminId])
  @@index([slug])
}

model Chapter {
  id String @id @default(cuid())

  title         String
  content       String         @db.Text
  order         Int            @default(0)
  courseId      String
  course        Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions     Question[]
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([courseId, order])
}

model Conversation {
  id String @id @default(cuid())

  chapterId String
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  //TODO: Check Unique stricness for: Can a student ever restart a conversation? Can they have multiple conv? how AI versions differ?

  @@unique([chapterId, studentId])
  @@index([studentId])
  @@index([chapterId])
}

model Message {
  id String @id @default(cuid())

  content String
  sender  SenderType
  model   AIModel?

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

enum SenderType {
  Student
  AI
}

model Question {
  id String @id @default(cuid())

  question      String
  answer        Answer?
  chapterId     String
  chapter       Chapter        @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  testQuestions TestQuestion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chapterId])
}

model Answer {
  id          String  @id @default(cuid())
  answer      String  @db.Text
  explanation String? @db.Text

  questionId String   @unique
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Test {
  id       String  @id @default(cuid())
  aiScore  Int?
  feedback String? @db.Text

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  testQuestions TestQuestion[]

  submittedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([studentId])
  @@index([courseId])
  @@index([courseId, aiScore])
}

model TestQuestion {
  id            String  @id @default(cuid())
  studentAnswer String? @db.Text
  aiScore       Int?
  aiFeedback    String?

  testId String
  test   Test   @relation(fields: [testId], references: [id], onDelete: Cascade)

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([testId])
}

model CreditBalance {
  id      String @id @default(cuid())
  userId  String @unique
  balance Float  @default(0)

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Transaction {
  id     String  @id @default(cuid())
  amount Float
  notes  String? @db.Text

  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  model            AIModel?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  creditBalanceId String
  creditBalance   CreditBalance @relation(fields: [creditBalanceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([creditBalanceId])
  @@index([createdAt])
}

enum AIModel {
  gpt_4o
  gpt_4o_mini
}
